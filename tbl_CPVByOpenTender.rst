.. _tbl_CPVByOpenTender:

tbl_CPVByOpenTender
===================

Данная аналитическая таблица хранит все предметы закупок, которые были успешно приобретены с помощью конкурентных методов закупок в текущем году.

Данная аналитическая таблица содержит следующую информацию:
 - Код предмета закупки
 - Год, для которого считались данные.
 
Пример того, как может выглядеть таблица:

==================== ===== ===
Код предмета закупки Год
-------------------- ----- ---
Код предмета 1       Год 1
Код предмета 2       Год 1
Код предмета 3       Год 1
Код предмета 4       Год 1
Код предмета 5       Год 1
...                  ...
==================== ===== ===

****************************
Расчет аналитической таблицы
****************************

****************************
Источники данных для расчета
****************************

Для расчета аналитической таблицы используются следующие источники данных:

- API системы государственных закупок в OCDS формате.

*************************************
Частота расчета аналитической таблицы
*************************************

Аналитическая таблица рассчитывается 1 раз в сутки.

****************
Поля для расчета
****************

- ``data.tender.status``
- ``data.tender.procurementMethod``
- ``data.tender.items.classification.scheme``
- ``data.tender.items.classification.id``
- ``data.awards.relatedLot``
- ``data.tender.datePublished``

***********************
Формула расчета таблицы
***********************

1. Перед расчетом таблица очищается.
2. Проводим расчеты отдельно для каждого календарного года, начиная с 2018-го.
3. Выбираем только процедуры, ``data.tender.procurementMethod = 'open'``, у которых ``data.tender.datePublished`` находится в текущем году.
4. Выбираем только завершенные процедуры ``data.tender.status = 'complete'``.
5. Из выбранных процедур выбираем все блоки определения победителя, где ``data.awards.status = 'active'``.
6. Из блоков определения победителя выбираем идентификаторы лотов, к которым относятся эти блоки ``data.awards.relatedLot``.
7. Находим все ``data.items``, которые относятся к этим лотам ``data.awards.relatedLot = data.items.relatedLot``.
8. Выбираем все коды закупок (конкатенация ``data.tender.items.classification.scheme`` и ``data.tender.items.classification.id``) из найденных ``data.items``.
9. Список из уникальных кодов закупок и год расчета заносим в таблицу.
