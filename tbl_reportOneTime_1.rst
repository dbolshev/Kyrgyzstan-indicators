.. _tbl_reportOneTime_1:


===================
tbl_reportOneTime_1
===================

Данная аналитическая таблица хранит все предметы закупок с их общими суммами в календарном году для каждой закупающей организации, которые она закупала методом заключения прямого договора, используя причину заключения "приобретения товаров, работ и услуг по каждой статье расходов один раз в год до минимальной пороговой суммы".

Данная аналитическая таблица содержит следующую информацию:
 - Идентификатор закупающей организации;
 - Код предмета закупки по общему классификатору государственных закупок;
 - Дата первой закупки данного предмета закупки;
 - Общую сумму проведенных закупок по данному предмету закупки;
 - Год, для которого расчитывается таблица.

Пример того, как может выглядеть таблица:

======================== ===================== ====== ======= =====
Закупающая организация   Код предмета закупки  Дата   Сумма   Год
------------------------ --------------------- ------ ------- -----
Закупающая организация 1 Код предмета 1        Дата 1 Сумма 1 Год 1    
Закупающая организация 1 Код предмета 2        Дата 2 Сумма 2 Год 2
Закупающая организация 1 Код предмета 3        Дата 3 Сумма 3 Год 3
Закупающая организация 2 Код предмета 1        Дата 1 Сумма 4 Год 4
Закупающая организация 2 Код предмета 2        Дата 2 Сумма 5 Год 5
....                     ....                  ...    ...     ...
======================== ===================== ====== ======= =====

****************************
Расчет аналитической таблицы
****************************

****************************
Источники данных для расчета
****************************

Для расчета аналитической таблицы используются следующие источники данных:

- API системы государственных закупок в OCDS формате.

*************************************
Частота расчета аналитической таблицы
*************************************

Аналитическая таблица рассчитывается 1 раз в сутки.

****************
Поля для расчета
****************

- ``data.tender.procurementMethodDetails``
- ``data.tender.procurementMethodRationale``
- ``data.tender.items.classification.scheme``
- ``data.tender.items.classification.id``
- ``data.tender.items.quantity``
- ``data.tender.items.relatedLot``
- ``data.awards.status``
- ``data.awards.relatedLot``
- ``data.awards.relatedBid``
- ``data.bids.priceProposal.relatedItem``
- ``data.bids.priceProposal.unit.value.amount``
- ``data.lots.status``
- ``parties.id``
- ``parties.roles``
- ``data.tender.datePublished``
- ``data.tender.status``
- ``data.tender.date``

***********************
Формула расчета таблицы
***********************
1. Перед расчетом таблица для текущего календарного года очищается. Таблицы, посчитанные для более ранних годов остаются неизменными.
2. Выбираем только процедуры прямого заключения договора (``data.tender.procurementMethodDetails = 'singleSource'``), ``data.tender.procurementMethodRationale = 'annualProcurement'``, у которых ``data.tender.datePublished`` находится в текущем году и ``data.tender.status = 'complete'`` или ``data.tender.status = 'active'``.
3. Из каждой найденной процедуры извлекаем идентификатор закупающей организации ``parties.id``, такой что ``parties.roles = 'buyer, procuringEntity'``.
4. Извлекаем дату последнего изменения статуса процедуры ``data.tender.date``.
5. Находим все награждения победителей, которые имеют статус ``data.awards.status = 'complete'`` и ссылаются на на лоты ``data.awards.relatedLot`` со статусом ``data.lots.status = 'complete'`` или ``data.lots.status = 'active'``.
6. Для каждого награждения победителя находим победное предложение участника ``data.awards.relatedBid``.
7. В найденном предложении для каждого предмета закупки ``data.bids.priceProposal`` выбираем цену единицы предмета закупки ``data.bids.priceProposal.unit.value.amount``.
8. Находим идентификатор предмета закупки ``data.bids.priceProposal.relatedItem`` и выбираем из него количество единиц для закупки ``data.tender.items.quantity`` и код предмета закупки ``data.tender.items.classification.id``.
9. Находим сумму предмета закупки как произведение ``data.tender.items.quantity`` и ``data.bids.priceProposal.unit.value.amount``.
10. Группируем данные по идентификатору ``parties.id``, найденному на 3-м шаге, коду предмета закупки ``data.tender.items.classification.id``, найденному на 8-м шаге, выбираея наименьшую дату ``data.tender.date``, найденную на 4-м шаге и сумму всех сумм предмета закупки, найденных на 9-м шаге.
11. Полученные данные сформируют нужную таблицу.

