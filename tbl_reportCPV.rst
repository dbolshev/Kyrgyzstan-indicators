.. _tbl_reportCPV:

tbl_reportCPV
=============

Данная аналитическая таблица хранит все предметы закупок для каждой закупающей организации, которые она закупала методом заключения прямого договора в календарном году.

Данная аналитическая таблица содержит следующую информацию:
 - Идентификатор закупающей организации;
 - Код предмета закупки по общему классификатору государственных закупок;
 - Дата первой закупки данного предмета закупки;
 - Год, для которого расчитывалась таблица.

Пример того, как может выглядеть таблица:

======================== ===================== ====== =====
Закупающая организация   Код предмета закупки  Дата   Год
------------------------ --------------------- ------ -----
Закупающая организация 1 Код предмета 1        Дата 1 Год 1    
Закупающая организация 1 Код предмета 2        Дата 2 Год 1
Закупающая организация 1 Код предмета 3        Дата 3 Год 1
Закупающая организация 2 Код предмета 1        Дата 1 Год 1
Закупающая организация 2 Код предмета 2        Дата 2 Год 1
....                     ....                  ...    ...
======================== ===================== ====== =====

****************************
Расчет аналитической таблицы
****************************

****************************
Источники данных для расчета
****************************

Для расчета аналитической таблицы используются следующие источники данных:

- API системы государственных закупок в OCDS формате.

*************************************
Частота расчета аналитической таблицы
*************************************

Аналитическая таблица рассчитывается 1 раз в сутки.

****************
Поля для расчета
****************

- ``data.tender.status``
- ``data.tender.procurementMethodDetails``
- ``data.tender.items.classification.id``
- ``data.tender.items.relatedLot``
- ``data.tender.lots.status``
- ``data.tender.lots.id``
- ``parties.id``
- ``parties.roles``
- ``data.tender.datePublished``
- ``data.tender.date``

***********************
Формула расчета таблицы
***********************
1. Перед расчетом таблица для текущего календарного года очищается. Таблицы, посчитанные для более ранних годов, остаются без изменений.
2. Для расчета берем процедуры, у которых ``data.tender.status = 'complete'`` и ``data.tender.procurementMethodDetails = 'singleSource'``. 
2. Для расчета берем те процедуры, у которых ``data.tender.datePublished`` находится в текущем году.
3. Из каждой найденной процедуры извлекаем идентификатор закупающей организации ``parties.id``, такой что ``parties.roles = 'buyer, procuringEntity'``.
4. Извлекаем дату завершения процедуры ``data.tender.date``.
5. Выбираем все значения классификаторов из текущей процедуры (``data.tender.items.classification.id``) только из тех лотов (``data.tender.items.relatedLot = data.tender.lots.id``), у которых ``data.tender.lots.status = 'complete'`` или ``data.tender.lots.status = 'active'``.
6. Группируем данные по идентификатору закупающей организации и предмету закупки, выбирая самую раннюю дату из пункта 4.
7. Полученные данные вместе с годом расчета заносим в таблицу.


